<!-- stock_detail.html -->
{% extends 'msestocks/base.html' %}

{% block title %}Stock Detail{% endblock %}

{% block content %}

<div class="container mt-5">
  <h1 class="mb-4">{{ stock.symbol }}</h1>
    <h2 class="mt-4">Historical Data</h2>

  <a href="{% url 'msestocks:index' %}" class="btn btn-primary mb-3">Back to Stock List</a>

    <div class="row">
        <div class="col-md-4 col-sm-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Stock Details</h3>
                </div>
                <div class="card-body">
                    <p class="card-text">Name: {{ stock.symbol }}</p>
                    <p class="card-text">Current Close Price: {{ stock.current_close_price|floatformat:2 }}</p>
                    <p class="card-text">Last Traded Volume: {{ stock.current_volume }}</p>
                    <p class="card-text">Current Turnover: {{ stock.current_turnover|floatformat:2 }}</p>
                </div>
                <div class="card-footer">
                    <p class="card-text text-center">Last updated: {{ stock.last_updated|date:"d/m/Y H:i" }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-8 col-sm-12">
          <div id="chart-controls" class="mb-2">
            <div class="btn-group btn-group-sm" role="group" aria-label="Timeframes">
              <button class="btn btn-outline-secondary active" data-range="1m">1 min</button>
              <button class="btn btn-outline-secondary" data-range="1h">1 hour</button>
              <button class="btn btn-outline-secondary" data-range="4h">4 hours</button>
              <button class="btn btn-outline-secondary" data-range="1d">1 day</button>
              <button class="btn btn-outline-secondary" data-range="1w">1 week</button>
              <button class="btn btn-outline-secondary" data-range="1M">1 month</button>
            </div>
            <div class="btn-group btn-group-sm ms-2" role="group" aria-label="Chart types">
              <button class="btn btn-outline-primary active" data-type="candlestick">Candlestick</button>
              <button class="btn btn-outline-primary" data-type="line">Line</button>
            </div>
          </div>
          <div id="chart" style="height: 360px;"></div>
        </div>
    </div>

    <table class="table table-striped d-md-none">
        <thead>
            <tr>
                <th>Date</th>
                <th>Open Price</th>
                <th>Close Price</th>
                <th>Percent Change</th>
                <th>Volume</th>
                <th>Turnover</th>
            </tr>
        </thead>
        <tbody>
            {% for data in stock.historical_data.all %}
            <tr>
                <td>{{ data.timestamp|date:"d/m/Y" }}</td>
                <td>{{ data.open_price|floatformat:2 }}</td>
                <td>{{ data.close_price|floatformat:2 }}</td>
                <td>{{ data.percent_change|floatformat:2 }}</td>
                <td>{{ data.volume}}</td>
                <td>{{ data.turnover}}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Include the moment.js and chartjs-adapter-moment scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <!-- lightweight-charts for TradingView-like charts -->
  <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>

    <script>
      // Use lightweight-charts for interactive trading-style charts.
  const stockId = "{{ stock.id }}";
      let rawSeries = [];
      let chart = null;
      let candleSeries = null;
      let lineSeries = null;

      function fetchSeries() {
        return fetch(`/msestocks/stocks/${stockId}/data/`)
          .then(r => r.json())
          .then(data => {
            rawSeries = data.map(d => ({
              time: d.time.split('T')[0], // YYYY-MM-DD
              open: Number(d.open),
              high: Number(d.high),
              low: Number(d.low),
              close: Number(d.close),
              volume: Number(d.volume || 0),
            }));
            return rawSeries;
          });
      }

      // simple aggregator (naive) for longer timeframes: group by day/week/month
      function aggregate(series, range) {
        if (!series || !series.length) return [];
        if (range === '1m' || range === '1h' || range === '4h') return series; // no intraday data

        const grouped = {};
        for (const p of series) {
          let key = p.time;
          if (range === '1w') {
            // week key (ISO week)
            const d = new Date(p.time);
            const year = d.getUTCFullYear();
            const week = Math.ceil((((d - new Date(Date.UTC(year,0,1))) / 86400000) + new Date(Date.UTC(year,0,1)).getUTCDay()+1)/7);
            key = `${year}-W${week}`;
          } else if (range === '1M') {
            const d = new Date(p.time);
            key = `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}`;
          }

          if (!grouped[key]) grouped[key] = {time: key, open: p.open, high: p.high, low: p.low, close: p.close, volume: p.volume};
          else {
            grouped[key].high = Math.max(grouped[key].high, p.high);
            grouped[key].low = Math.min(grouped[key].low, p.low);
            grouped[key].close = p.close;
            grouped[key].volume += p.volume;
          }
        }

        // return sorted by time
        return Object.values(grouped).sort((a,b) => a.time.localeCompare(b.time));
      }

      function createLightweightChart(container) {
        chart = LightweightCharts.createChart(container, {layout: {backgroundColor: '#ffffff', textColor: '#333'}, width: container.clientWidth, height: 360});
        candleSeries = chart.addCandlestickSeries();
        lineSeries = chart.addLineSeries({color: '#1f77b4'});
      }

      function renderRange(range, type) {
        const data = aggregate(rawSeries, range);
        if (!chart) createLightweightChart(document.getElementById('chart'));
        if (type === 'candlestick') {
          lineSeries.applyOptions({visible: false});
          candleSeries.applyOptions({visible: true});
          candleSeries.setData(data.map(d => ({time: d.time, open: d.open, high: d.high, low: d.low, close: d.close}))); 
        } else {
          candleSeries.applyOptions({visible: false});
          lineSeries.applyOptions({visible: true});
          lineSeries.setData(data.map(d => ({time: d.time, value: d.close}))); 
        }
      }

      // wire controls
      document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('chart');
        createLightweightChart(container);
        fetchSeries().then(() => {
          // default view
          renderRange('1d', 'candlestick');
        }).catch(err => console.error('failed to fetch series', err));

        // timeframe buttons
        document.querySelectorAll('#chart-controls [data-range]').forEach(btn => btn.addEventListener('click', (e) => {
          document.querySelectorAll('#chart-controls [data-range]').forEach(b=>b.classList.remove('active'));
          e.target.classList.add('active');
          const range = e.target.getAttribute('data-range');
          const activeType = document.querySelector('#chart-controls [data-type].active').getAttribute('data-type');
          renderRange(range, activeType);
        }));

        // chart type buttons
        document.querySelectorAll('#chart-controls [data-type]').forEach(btn => btn.addEventListener('click', (e) => {
          document.querySelectorAll('#chart-controls [data-type]').forEach(b=>b.classList.remove('active'));
          e.target.classList.add('active');
          const type = e.target.getAttribute('data-type');
          const activeRange = document.querySelector('#chart-controls [data-range].active').getAttribute('data-range');
          renderRange(activeRange, type);
        }));
      });
    </script>

{% endblock %}
